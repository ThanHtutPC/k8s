Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  # Shared settings
  config.vm.provider :libvirt do |libvirt|
    libvirt.memory = 1024
    libvirt.cpus = 1
    libvirt.machine_type = "q35"
  end

  # Provision script (install kubeadm, kubelet, kubectl, containerd)
  provision_script = <<-SHELL
    set -e
    sudo apt update && sudo apt upgrade -y
    sudo apt install -y apt-transport-https ca-certificates curl gpg

    # Containerd
    sudo apt install -y containerd
    sudo mkdir -p /etc/containerd
    containerd config default | sudo tee /etc/containerd/config.toml
    sudo systemctl restart containerd

    # Kubernetes repo
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | \
      sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
    https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | \
    sudo tee /etc/apt/sources.list.d/kubernetes.list

    sudo apt update
    sudo apt install -y kubelet kubeadm kubectl
    sudo apt-mark hold kubelet kubeadm kubectl
  SHELL

  # Control plane
  config.vm.define "k8s-control" do |node|
    node.vm.hostname = "k8s-control"
    node.vm.network "private_network", ip: "192.168.56.10"
    node.vm.provision "shell", inline: provision_script
  end

  # Worker 1
  config.vm.define "k8s-worker1" do |node|
    node.vm.hostname = "k8s-worker1"
    node.vm.network "private_network", ip: "192.168.56.11"
    node.vm.provision "shell", inline: provision_script
  end

  # Worker 2
  config.vm.define "k8s-worker2" do |node|
    node.vm.hostname = "k8s-worker2"
    node.vm.network "private_network", ip: "192.168.56.12"
    node.vm.provision "shell", inline: provision_script
  end
end
